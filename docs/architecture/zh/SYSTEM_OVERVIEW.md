[English](../en/SYSTEM_OVERVIEW.md) | [简体中文](SYSTEM_OVERVIEW.md)

---

# Runicorn 系统概述

**文档类型**: 架构  
**版本**: v0.4.0  
**最后更新**: 2025-10-14

---

## 目的

本文档提供 Runicorn 系统架构的高层概述，解释整体设计、技术选择和核心原则。

---

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户层                                    │
│  ┌──────────┬──────────┬────────────┬──────────────────────┐  │
│  │ Python   │ Web UI   │ 桌面应用   │ CLI                  │  │
│  │ SDK      │ (浏览器) │ (Tauri)    │ 命令                 │  │
│  └────┬─────┴─────┬────┴──────┬─────┴────────────┬─────────┘  │
└───────┼───────────┼───────────┼──────────────────┼────────────┘
        │           │           │                  │
┌───────▼───────────▼───────────▼──────────────────▼────────────┐
│                     API 层 (FastAPI)                            │
│  ┌──────────┬──────────┬──────────┬──────────┬─────────────┐ │
│  │ Runs API │ Artifacts│ Metrics  │ Config   │ SSH/Remote  │ │
│  │ (V1/V2)  │ API      │ API      │ API      │ API         │ │
│  └────┬─────┴─────┬────┴────┬─────┴────┬─────┴──────┬──────┘ │
└───────┼───────────┼─────────┼──────────┼────────────┼────────┘
        │           │         │          │            │
┌───────▼───────────▼─────────▼──────────▼────────────▼────────┐
│                   业务逻辑层                                     │
│  ┌──────────────┬──────────────┬──────────────────────────┐  │
│  │ 实验         │ Artifact     │ 环境                     │  │
│  │ 管理器       │ 存储         │ 捕获                     │  │
│  └──────┬───────┴──────┬───────┴──────────────┬──────────┘  │
└─────────┼──────────────┼────────────────────────┼───────────┘
          │              │                        │
┌─────────▼──────────────▼────────────────────────▼───────────┐
│                  存储层 (混合)                                 │
│  ┌────────────────────┬─────────────────────────────────┐   │
│  │ SQLite 后端        │ 文件系统                        │   │
│  │ - experiments 表   │ - runs/ (元数据, 日志)          │   │
│  │ - metrics 表       │ - artifacts/ (模型, 数据集)     │   │
│  │ - 索引             │ - .dedup/ (去重池)              │   │
│  └────────────────────┴─────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────┘
```

---

## 技术栈

### 后端

| 技术 | 版本 | 用途 | 选择原因 |
|------|------|------|----------|
| **Python** | 3.8+ | 核心语言 | 生态系统，ML 社区标准 |
| **FastAPI** | 0.110+ | API 框架 | 现代，异步，自动文档，高性能 |
| **SQLite** | 3.x | 元数据存储 | 零配置，可移植，ACID |
| **Paramiko** | 3.3+ | SSH 客户端 | 纯 Python，维护良好 |
| **Uvicorn** | 0.23+ | ASGI 服务器 | 高性能，生产就绪 |

### 前端

| 技术 | 版本 | 用途 | 选择原因 |
|------|------|------|----------|
| **React** | 18.2 | UI 框架 | 组件复用性，生态系统 |
| **TypeScript** | 5.4+ | 类型安全 | 早期发现错误，更好的 IDE 支持 |
| **Ant Design** | 5.19+ | UI 组件 | 专业，全面，国际化 |
| **ECharts** | 5.5+ | 图表 | 强大，高性能，ML 专用 |
| **Vite** | 5.3+ | 构建工具 | 快速 HMR，优化构建 |

### 桌面

| 技术 | 版本 | 用途 | 选择原因 |
|------|------|------|----------|
| **Tauri** | 最新 | 桌面封装 | 轻量，安全，跨平台 |
| **Rust** | 稳定版 | 原生后端 | 性能，安全性 |

---

## 核心设计原则

### 1. 隐私优先

**原则**: 所有数据保持本地，零遥测

**实现**:
- 除 SSH（用户发起）外无外部网络调用
- 无分析、跟踪或使用报告
- 无云依赖

**理由**: ML 研究经常涉及敏感或专有数据

---

### 2. 零配置

**原则**: 开箱即用，合理默认值

**实现**:
- SQLite 数据库自动创建
- 存储目录自动初始化
- 无需数据库服务器设置
- 默认配置适用于大多数用户

**理由**: 降低入门门槛，专注于研究而非设置

---

### 3. 性能可扩展

**原则**: 小规模和大规模都快

**实现**:
- 混合存储：大数据用文件，查询用 SQLite
- V2 API：10,000+ 实验快 100 倍
- 连接池和缓存
- 高效索引

**理由**: 支持从个人研究者（10 个实验）到实验室（10,000 个实验）

---

### 4. 向后兼容

**原则**: 永不破坏现有用户代码

**实现**:
- V1 API 与 V2 并存
- 自动存储迁移
- 可选的新功能
- 语义化版本控制

**理由**: 研究工作流需要信任和稳定性

---

### 5. 自包含

**原则**: 最少依赖，离线可用

**实现**:
- 前端打包在 Python 包中
- 不需要 Node.js 运行时
- 优先使用标准库
- 额外功能使用可选依赖

**理由**: 在隔离环境工作，减少安装问题

---

## 系统边界

### 范围内

✅ **本地实验追踪**
- 记录指标、日志、图像
- 分层组织实验
- 对比多个运行

✅ **模型版本控制**
- 自动版本管理
- 内容去重
- 血缘追踪

✅ **本地优先协作**
- 基于 SSH 的远程同步
- 网络驱动器上的共享存储
- 导出/导入传输

✅ **可视化**
- 实时指标图表
- 日志流
- Artifact 血缘图

### 范围外

❌ **云托管** - Runicorn 仅自托管
❌ **多租户** - 为单用户/团队设计
❌ **分布式存储** - 无内置复制
❌ **认证** - 本地 API，无需认证
❌ **团队权限** - 无 RBAC 系统

---

## 高层组件

### 1. SDK 层

**职责**: 面向用户的 Python API

**关键类**:
- `Run`: 实验上下文和生命周期
- `Artifact`: 版本控制的资产
- 模块级函数: `init()`, `log()`, `finish()`

**设计模式**: 单例活动运行，线程安全

---

### 2. 存储层

**职责**: 持久化数据管理

**组件**:
- **SQLite 后端**: 快速元数据查询
- **文件系统**: 大文件、日志、媒体
- **混合协调器**: 同步两个后端

**设计模式**: 策略模式用于后端

---

### 3. API 层

**职责**: 存储的 HTTP 接口

**组件**:
- **路由模块**: 按功能组织（runs, artifacts等）
- **服务层**: 业务逻辑抽象
- **中间件**: CORS，速率限制，日志

**设计模式**: 分层架构，依赖注入

---

### 4. Web UI

**职责**: 可视化和交互

**组件**:
- **React App**: 带客户端路由的 SPA
- **组件**: 可复用 UI 元素
- **状态管理**: Context API + localStorage
- **API 客户端**: 集中式 HTTP 层

**设计模式**: 基于组件，单向数据流

---

### 5. Artifacts 系统

**职责**: ML 资产版本控制

**组件**:
- **Artifact 存储**: 物理文件管理
- **版本索引**: 元数据和版本控制
- **去重池**: 内容寻址存储
- **血缘追踪器**: 依赖图构建器

**设计模式**: 内容寻址存储，不可变版本

---

### 6. 远程同步

**职责**: 基于 SSH 的数据同步

**组件**:
- **SSH 客户端**: 基于 Paramiko 的连接
- **元数据同步**: JSON 文件同步
- **文件获取器**: 按需 SFTP 下载
- **缓存管理器**: 本地元数据缓存

**设计模式**: 适配器模式，延迟加载

---

## 数据存储布局

```
user_root_dir/
├── runicorn.db                 # SQLite 数据库
│   ├── experiments 表          # 实验元数据
│   ├── metrics 表              # 指标数据点
│   └── 索引                    # 性能索引
│
├── artifacts/                  # 版本化资产
│   ├── model/
│   │   └── {name}/
│   │       ├── versions.json   # 版本索引
│   │       └── v{N}/           # 版本目录
│   │           ├── metadata.json
│   │           ├── manifest.json
│   │           └── files/
│   └── .dedup/                 # 内容去重池
│       └── {hash[:2]}/
│           └── {hash}/
│
└── {project}/                  # 实验层级
    └── {name}/
        └── runs/
            └── {run_id}/
                ├── meta.json
                ├── status.json
                ├── summary.json
                ├── events.jsonl
                ├── logs.txt
                └── media/
```

---

## 关键设计决策

### 混合存储（SQLite + 文件）

**决策**: 同时使用 SQLite 和文件系统

**理由**:
- SQLite 擅长查询、聚合、过滤
- 文件擅长大型二进制、人类可读日志
- 混合获得两者优势

**权衡**: 双写复杂性，但性能提升值得

---

### 内容去重

**决策**: 基于 SHA256 的去重 + 硬链接

**理由**:
- ML 模型经常共享层（预训练权重）
- 硬链接：零拷贝去重
- SHA256：安全，快速，抗碰撞

**权衡**: 跨文件系统限制，但 50-90% 空间节省

---

### 版本控制（非 Git）

**决策**: 为 artifacts 使用自定义版本系统

**理由**:
- Git 不适合大型二进制文件
- Git-LFS 增加复杂性和外部依赖
- 自定义系统：更简单，更快，更好的用户体验

**权衡**: 无 Git 功能，但针对 ML 工作流优化

---

## 性能特征

### 查询性能

| 操作 | V1 (文件) | V2 (SQLite) | 提升 |
|------|-----------|-------------|------|
| 列出 100 个实验 | 500毫秒 | 5毫秒 | 100倍 |
| 列出 1000 个实验 | 5秒 | 50毫秒 | 100倍 |
| 按项目过滤 | 5秒 | 30毫秒 | 167倍 |
| 复杂查询 | 不适用 | 80毫秒 | ∞ |

### 存储效率

| 场景 | 不去重 | 去重后 | 节省 |
|------|--------|--------|------|
| 10 个模型检查点 | 10 GB | 1.5 GB | 85% |
| 100 个相似模型 | 100 GB | 20 GB | 80% |

### 可扩展性限制

| 指标 | 已测试 | 实际限制 | 注释 |
|------|--------|----------|------|
| 实验数 | 100,000 | ~500,000 | 需要 V2 API |
| Artifacts | 10,000 | ~50,000 | 去重池大小 |
| 指标点 | 1000万 | ~1亿 | 每个实验 |
| 并发用户 | 100 | ~500 | SQLite WAL 模式 |

---

## 系统约束

### 按设计

1. **单机**: 非分布式（为简单性而选择）
2. **本地优先**: 网络是可选的（用于离线工作）
3. **Python 生态**: 与 ML 工具紧密集成

### 技术限制

1. **SQLite 限制**:
   - 一次一个写入者（WAL 模式有帮助）
   - 不适合 >1000 并发写入/秒
   - 数据库文件可能变大（10万实验 100MB+）

2. **文件系统限制**:
   - 硬链接需要相同文件系统/驱动器
   - Windows 路径长度（260 字符，已缓解）
   - 大小写敏感性因操作系统而异

3. **WebSocket 限制**:
   - 并发连接数（取决于操作系统）
   - 浏览器限制（每域名~6个连接）

---

## 扩展点

### 面向开发者

**插件系统**（计划中）:
- 自定义存储后端
- 自定义导出器
- 自定义可视化

**钩子**（当前）:
- 环境捕获：可插拔
- 监控器：可选监控钩子

---

## 与替代方案对比

### vs. Weights & Biases

| 方面 | W&B | Runicorn |
|------|-----|----------|
| **部署** | 云（SaaS）| 自托管 |
| **隐私** | 数据在 W&B 服务器 | 100% 本地 |
| **成本** | $50+/用户/月 | 免费，开源 |
| **设置** | 需要账户 | `pip install` |
| **性能** | 优秀 | 优秀（V2 API）|
| **协作** | 内置 | SSH 同步 |

### vs. MLflow

| 方面 | MLflow | Runicorn |
|------|--------|----------|
| **设置** | 中等（服务器）| 简单（无服务器）|
| **存储** | 各种后端 | SQLite + 文件 |
| **版本控制** | 模型注册表 | Artifacts 系统 |
| **性能** | 好 | 优秀（快 100 倍）|
| **去重** | 无 | 是（节省 50-90%）|

### vs. TensorBoard

| 方面 | TensorBoard | Runicorn |
|------|-------------|----------|
| **UI** | 基础 | 现代（Ant Design）|
| **对比** | 有限 | 完整多运行 |
| **版本控制** | 无 | 内置 |
| **状态追踪** | 无 | 自动检测崩溃 |
| **存储** | 事件文件 | 混合优化 |

---

## 已实现的设计目标

✅ **隐私**: 零外部调用，所有数据本地  
✅ **性能**: 查询快 100 倍（V2 API）  
✅ **简单性**: `pip install`，零配置  
✅ **可扩展性**: 测试至 100,000 个实验  
✅ **效率**: 50-90% 存储节省  
✅ **兼容性**: Python 3.8-3.13，Windows/Linux/macOS  
✅ **可扩展性**: 模块化架构  
✅ **离线**: 无网络完全功能  

---

## 未来架构方向

### v0.5.0（计划中）

- **超参数优化**: 集成 Optuna/Ray Tune
- **模型部署**: 导出到 ONNX/TorchScript
- **高级分析**: 自动化洞察

### v1.0.0（愿景）

- **插件系统**: 可扩展架构
- **多存储**: 可选云后端
- **高级协作**: 共享存储的冲突解决

---

## 相关架构文档

- **[COMPONENT_ARCHITECTURE.md](COMPONENT_ARCHITECTURE.md)** - 详细组件设计
- **[STORAGE_DESIGN.md](STORAGE_DESIGN.md)** - 存储层深入
- **[DATA_FLOW.md](DATA_FLOW.md)** - 数据如何流经系统
- **[DESIGN_DECISIONS.md](DESIGN_DECISIONS.md)** - 为何做出这些选择

---

## 更多信息

- **API 规范**: 查看 [../../api/](../../api/)
- **用户指南**: 查看 [../../guides/](../../guides/)
- **代码**: 查看 `src/runicorn/`

---

**导航**: [架构文档索引](README.md) | [主文档](../../README.md)


